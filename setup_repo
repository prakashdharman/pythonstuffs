#!/bin/bash

set -euo pipefail

# Configuration
BASE_DIR="/opt/mgr/users"
ONBOARDING_REPO_URL="https://your.git.server/org/onb.git"
CORE_REPO_URL="https://your.git.server/org/c.git"
ONBOARDING_BASE_BRANCH="master"
CORE_BRANCH="develop"

# ----

# Get username
if [ -n "${1:-}" ]; then
    USERNAME="$1"
else
    read -rp "Enter the username: " USERNAME
    if [ -z "$USERNAME" ]; then
        echo "Error: Username cannot be empty."
        exit 1
    fi
fi

USER_DIR="$BASE_DIR/$USERNAME"
ONBOARDING_DIR="$USER_DIR/onboarding"
CORE_DIR="$USER_DIR/core"

echo "Creating user folder: $USER_DIR"
mkdir -p "$USER_DIR"

# Clone Onboarding Repo from master, pull LFS objects, create user branch, push it
echo "Cloning Onboarding Repo..."
git clone --branch "$ONBOARDING_BASE_BRANCH" "$ONBOARDING_REPO_URL" "$ONBOARDING_DIR"

echo "Fetching Git LFS objects..."
cd "$ONBOARDING_DIR"
git lfs pull

echo "Creating new branch '$USERNAME' in onboarding repo..."
git checkout -b "$USERNAME"
git push -u origin "$USERNAME"

# Clone Core Repo and checkout develop
echo "Cloning Core Repo..."
git clone --branch "$CORE_BRANCH" "$CORE_REPO_URL" "$CORE_DIR"

echo "Done. Onboarding repo on '$USERNAME' branch, Core repo on '$CORE_BRANCH', for user '$USERNAME'."
